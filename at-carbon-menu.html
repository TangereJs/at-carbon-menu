<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">

<dom-module id="at-carbon-menu">
  <template>
    <style include="at-form-common"></style>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent; /* this fixes tap flickering on iPad/iPhone*/
      }

      :host:focus {
        outline: none;
      }

      .carbon-menu-item {
        padding: 6px 12px;
        cursor: pointer;
        @apply(--at-form-label-font);
      }

      .carbon-menu-item.highlighted {
        @apply(--at-text-selected);
      }

      .carbon-menu-item.selected,
      .carbon-menu-item.selected.highlighted {
        @apply(--at-text-primary-selected);
      }

      #insertPoint:focus {
        outline: none;
      }

    </style>

    <div id="insertPoint" on-tap="_insertPoint_onTap" on-mouseover="_insertPoint_onMouseover" tabindex="0"></div>

  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-carbon-menu',
      listeners: {
        'insertPoint.tap': '_host_onTap',
        'insertPoint.keydown': '_host_onKeydown',
        'insertPoint.focus': '_initHighlighted'
      },
      properties: {
        items: {
          type: Array,
          value: function() {
            return [];
          },
          observer: '_itemsChanged',
          schema: {
            items: {
              properties: {
                title: {
                  type: String,
                  title: "Title",
                  "default": ""
                },
                value: {
                  type: String,
                  title: "Value",
                  "default": ""
                }
              }
            }
          }
        },
        value: {
          type: String,
          value: "",
          observer: '_valueChanged'
        }
      },

      _keyCodes: {
        ESC: 27,
        TAB: 9,
        ARROW_UP: 38,
        ARROW_DOWN: 40,
        ENTER: 13,
        SPACE: 32
      },
      ready: function() {
      },
      _host_onTap: function(event) {
        if (this._isEnterAsTap) {
          this._isEnterAsTap = false;
          return ;
        }

        var itemsLen = this.items.length;
        if (itemsLen < 1) { return; }

        this._initHighlighted();
      },
      _insertPoint_onTap: function (event) {
        var highlighted = event.target;
        var attrValue = highlighted.getAttribute('carbon-menu-value');
        if (!attrValue) { return ; }

        var insertPoint = this.$.insertPoint;
        var selected = Polymer.dom(insertPoint).querySelector('.selected');
        if (selected) {
          Polymer.dom(selected).classList.remove('selected');
          Polymer.dom(selected).classList.remove('highlighted');
        }

        Polymer.dom(highlighted).classList.add('highlighted');
        Polymer.dom(highlighted).classList.add('selected');

        this.value = attrValue;
        this.fire('value-changed', { value: this.value });
      },
      _insertPoint_onMouseover: function (event) {
        var insertPoint = this.$.insertPoint;
        var highlighted = Polymer.dom(insertPoint).querySelector('.highlighted');
        if (highlighted) {
          Polymer.dom(highlighted).classList.remove('highlighted');
        }

        var target = event.target;
        Polymer.dom(target).classList.add('highlighted');
      },
      _host_onKeydown: function(event) {
        var keyCodes = this._keyCodes;
        var keyCode = event.which;

        switch (keyCode) {
          case keyCodes.ENTER:
          case keyCodes.SPACE:
            this._isEnterAsTap = true;
            this._select();
            break;
          case keyCodes.ESC:
            break;
          case keyCodes.ARROW_UP:
            this._highlightPrevious();
            break;
          case keyCodes.ARROW_DOWN:
            this._highlightNext();
            break;
          case keyCodes.TAB:
            break;
          default:
            break;
        }
      },
      _initHighlighted: function() {
        var insertPoint = this.$.insertPoint;

        var highlighted = Polymer.dom(insertPoint).querySelector('.highlighted');
        if (highlighted) {
          Polymer.dom(highlighted).classList.remove('highlighted');
        }

        var selected = Polymer.dom(insertPoint).querySelector('.selected');
        if (!selected && !highlighted) {
          var firstElemChild = Polymer.dom(insertPoint).firstElementChild;
          if (firstElemChild) {
            Polymer.dom(firstElemChild).classList.add('highlighted');
            Polymer.dom(firstElemChild).classList.add('selected');
          }
        } else if (selected) {
          Polymer.dom(selected).classList.add('highlighted');
        }
      },
      _highlightPrevious: function() {
        var insertPoint = this.$.insertPoint;
        var highlighted = Polymer.dom(insertPoint).querySelector('.highlighted');
        if (highlighted) {
          Polymer.dom(highlighted).classList.remove('highlighted');
          var prevElemSibling = Polymer.dom(highlighted).previousElementSibling;
          if (prevElemSibling) {
            Polymer.dom(prevElemSibling).classList.add('highlighted');
          } else {
            var lastElemChild = Polymer.dom(insertPoint).lastElementChild;
            if (lastElemChild) {
              Polymer.dom(lastElemChild).classList.add('highlighted');
            }
          }
        } else {
          var selected = Polymer.dom(insertPoint).querySelector('.selected');
          if (selected) {
            var prevElemSibling = Polymer.dom(selected).previousElementSibling;
            if (prevElemSibling) {
              Polymer.dom(prevElemSibling).classList.add('highlighted');
            } else {
              var lastElemChild = Polymer.dom(insertPoint).lastElementChild;
              if (lastElemChild) {
                Polymer.dom(lastElemChild).classList.add('highlighted');
              }
            }
          }
        }
      },
      _highlightNext: function() {
        var insertPoint = this.$.insertPoint;
        var highlighted = Polymer.dom(insertPoint).querySelector('.highlighted');
        if (highlighted) {
          Polymer.dom(highlighted).classList.remove('highlighted');
          var nextElemSibling = Polymer.dom(highlighted).nextElementSibling;
          if (nextElemSibling) {
            Polymer.dom(nextElemSibling).classList.add('highlighted');
          } else {
            var firstElemChild = Polymer.dom(insertPoint).firstElementChild;
            if (firstElemChild) {
              Polymer.dom(firstElemChild).classList.add('highlighted');
            }
          }
        } else {
          var selected = Polymer.dom(insertPoint).querySelector('.selected');
          if (selected) {
            var nextElemSibling = Polymer.dom(selected).nextElementSibling;
            if (nextElemSibling) {
              Polymer.dom(nextElemSibling).classList.add('highlighted');
            } else {
              var firstElemChild = Polymer.dom(insertPoint).firstElementChild;
              if (firstElemChild) {
                Polymer.dom(firstElemChild).classList.add('highlighted');
              }
            }
          }
        }
      },
      _select: function() {
        var insertPoint = this.$.insertPoint;
        var selected = Polymer.dom(insertPoint).querySelector('.selected');
        if (selected) {
          Polymer.dom(selected).classList.remove('selected');
        }

        var highlighted = Polymer.dom(insertPoint).querySelector('.highlighted');
        if (highlighted) {
          Polymer.dom(highlighted).classList.add('selected');

          this.value = highlighted.getAttribute('carbon-menu-value');
          this.fire('value-changed', { value: this.value });
        }

      },
      _clearInsertPoint: function() {
        var insertPoint = this.$.insertPoint;
        var firstChild = Polymer.dom(insertPoint).firstChild;

        while (firstChild) {
          Polymer.dom(insertPoint).removeChild(firstChild);
          firstChild = Polymer.dom(insertPoint).firstChild;
        }

        Polymer.dom.flush();
      },
      _itemsChanged: function(newValue, oldValue) {
        this._clearInsertPoint();
        var insertPoint = this.$.insertPoint;
        var itemPrototype = document.createElement('div');
        Polymer.dom(itemPrototype).classList.add('carbon-menu-item');
        var ipDocumentFragmet = document.createDocumentFragment();
        var itemDiv;
        var item;

        // new value is an array of title, name (value) pairs
        for (var i = 0; i < newValue.length; i++) {
          item = newValue[i];
          itemDiv = itemPrototype.cloneNode();
          Polymer.dom(itemDiv).setAttribute('carbon-menu-value', item.value);
          Polymer.dom(itemDiv).textContent = item.title;
          Polymer.dom(ipDocumentFragmet).appendChild(itemDiv);
        }
        Polymer.dom(insertPoint).appendChild(ipDocumentFragmet);
        Polymer.dom.flush();
      },
      _valueChanged: function(newValue, oldValue) {
        var insertPoint = this.$.insertPoint;
        var selected = Polymer.dom(insertPoint).querySelector('.selected');
        if (selected) {
          Polymer.dom(selected).classList.remove('selected');
          Polymer.dom(selected).classList.remove('highlighted');
        }

        var toSelect = Polymer.dom(insertPoint).querySelector('div[carbon-menu-value=' + newValue + ']');
        if (toSelect) {
          Polymer.dom(toSelect).classList.add('selected');
          Polymer.dom(toSelect).classList.add('highlighted');
        }
      }
    });
  </script>
</dom-module>
